<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Demo</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone@7.12.6/babel.js" crossorigin></script>
  <script src="https://unpkg.com/ionicons@5/dist/ionicons/ionicons.esm.js" type="module" crossorigin></script>
</head>
<body>

<div id="root"></div>

<script type="text/jsx">

// ##########################

const api = {
  get (url) {
    switch (url) {
      case '/lots':
        return new Promise((resolve, reject) => {
          setTimeout(() => {
            if (Math.random() > 0.25) {
              resolve([
                {
                  id: 1,
                  name: 'Apple',
                  description: 'Apple description',
                  price: 16,
                  favorite: true
                },
                {
                  id: 2,
                  name: 'Orange',
                  description: 'Orange description',
                  price: 41,
                  favorite: false
                }
              ])
            } else {
              reject(new Error('Connection error'))
            }
          }, 1000)
        })
      default:
        throw new Error('Unknown address')
    }
  },
  post (url) {
    if (/^\/lots\/(\d+)\/favorite$/.exec(url)) {
      return new Promise((resolve) => {
        setTimeout(() => {
          resolve({})
        }, 500)
      })
    }
    if (/^\/lots\/(\d+)\/unfavorite$/.exec(url)) {
      return new Promise((resolve) => {
        setTimeout(() => {
          resolve({})
        }, 500)
      })
    }
    throw new Error('Unknown address')
  }
}

const stream = {
  subscribe (channel, listener) {
    const match = /price-(\d+)/.exec(channel)
    if (match) {
      const interval = setInterval(() => {
        listener({
          id: parseInt(match[1]),
          price: Math.round((Math.random() * 10 + 30))
        })
      }, 400)
      return () => clearInterval(interval)
    }
  }
}

// ##########################

function App () {
  return (
    <div className="app">
      <Header />
      <ClockContainer />
      <LotsContainer />
    </div>
  )
}

function Header () {
  return (
    <header className="header">
      <Logo />
    </header>
  )
}

function Logo () {
  return <img className="logo" src="logo.png" alt="" />
}

function ClockContainer () {
  const [time, setTime] = React.useState(new Date())

  React.useEffect(() => {
    const interval = setInterval(() => {
      setTime(new Date())
    }, 1000)
    return () => clearInterval(interval)
  }, [setTime])

  return <Clock time={time} />
}

function Clock ({ time }) {
  const isDay = time.getHours() >= 7 && time.getHours() <= 21

  return (
    <div className="clock">
      <span className="value">{time.toLocaleTimeString()}</span>
      <span className={isDay ? 'icon day' : 'icon night'} />
    </div>
  )
}

function Loading () {
  return <div className="loading">Loading...</div>
}

function AlertError ({ message }) {
  return <div className="error">{message}</div>
}

function LotsContainer () {
  const [items, setItems] = React.useState({
    lots: [],
    loading: false,
    loaded: false,
    error: null
  })

  const { lots, loading, loaded, error } = items

  React.useEffect(() => {
    if (!loaded && !loading && error === null) {
      setItems((items) => ({
        ...items,
        loading: true,
        loaded: false,
        error: null
      }))
      api.get('/lots')
        .then((lots) => {
          setItems((items) => ({
            ...items,
            lots,
            loading: false,
            loaded: true,
            error: null
          }))
        })
        .catch((error) => {
          setItems((items) => ({
            ...items,
            loading: false,
            loaded: false,
            error: error.message
          }))
        })
    }
  }, [loaded, loading, error])

  if (error !== null) {
    return <AlertError message={error} />
  }

  if (loading) {
    return <Loading />
  }

  if (!loaded) {
    return null
  }

  const subscribe = (id) => {
    return stream.subscribe(`price-${id}`, (data) => {
      setItems((items) => ({
        ...items,
        lots: items.lots.map((lot) => {
          if (lot.id === data.id) {
            return {
              ...lot,
              price: data.price
            }
          }
          return lot
        })
      }))
    })
  }

  const favorite = (id) => {
     api.post(`/lots/${id}/favorite`).then(() => {
       setItems((items) => ({
         ...items,
         lots: items.lots.map((lot) => {
           if (lot.id === id) {
             return {
               ...lot,
               favorite: true
             }
           }
           return lot
         })
       }))
     })
  }

  const unfavorite = (id) => {
     api.post(`/lots/${id}/unfavorite`).then(() => {
       setItems((items) => ({
         ...items,
         lots: items.lots.map((lot) => {
           if (lot.id === id) {
             return {
               ...lot,
               favorite: false
             }
           }
           return lot
         })
       }))
     })
  }

  return <Lots lots={lots} subscribe={subscribe} favorite={favorite} unfavorite={unfavorite} />
}

function Lots ({ lots, subscribe, favorite, unfavorite }) {
  return (
    <div className="lots">
      {lots.map((lot) => <LotContainer lot={lot} subscribe={subscribe} favorite={favorite} unfavorite={unfavorite} key={lot.id} />)}
    </div>
  )
}

function LotContainer ({ lot, subscribe, favorite, unfavorite }) {
  React.useEffect(() => {
    return subscribe(lot.id)
  }, [lot.id])

  return <Lot lot={lot} favorite={favorite} unfavorite={unfavorite} />
}

function Lot ({ lot, favorite, unfavorite }) {
  return (
    <article className={'lot' + (lot.favorite ? ' favorite' : '')}>
      <div className="price">{lot.price}</div>
      <h1>{lot.name}</h1>
      <p>{lot.description}</p>
      <Favorite
        active={lot.favorite}
        favorite={() => favorite(lot.id)}
        unfavorite={() => unfavorite(lot.id)}
      />
    </article>
  )
}

function Favorite ({ active, favorite, unfavorite }) {
  return active ? (
    <button type="button" onClick={unfavorite} className="unfavorite">
      <ion-icon name="heart-sharp" /> Unfavorite
    </button>
  ) : (
    <button type="button" onClick={favorite} className="favorite">
      <ion-icon name="heart-outline" /> Favorite
    </button>
  )
}

// ##########################

ReactDOM.render(
  <App />,
  document.getElementById('root')
)

// ##########################

</script>

</body>
</html>
